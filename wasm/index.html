<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content"/>
        <title>Go JS Runtime REPL</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="wasm_exec.js"></script>
        <script>
            const go = new Go();
            WebAssembly.instantiateStreaming(fetch("go-js.wasm"), go.importObject).then((result) => {
                go.run(result.instance);
                addWelcomeMessage();
            });

            function addWelcomeMessage() {
                const terminal = document.getElementById('terminal');
                const welcome = document.createElement('div');
                welcome.className = 'mb-4 text-green-400';
                welcome.innerHTML = `go-js Runtime v0.0.1<br>Type JavaScript code and press Enter to execute.<br>Press Shift+Enter for multi-line input.<br>Type 'clear' to clear the terminal.<br>`;
                terminal.appendChild(welcome);
                focusInput();
            }

            function executeCode() {
                const input = document.getElementById('terminal-input');
                const code = input.value;
                const terminal = document.getElementById('terminal');
                
                if (!code.trim()) {
                    return;
                }

                // Add prompt and input to terminal
                const inputLine = document.createElement('div');
                inputLine.className = 'mb-2';
                inputLine.innerHTML = `<span class="text-green-400">$</span> <span class="text-gray-100 whitespace-pre-wrap">${escapeHtml(code)}</span>`;
                terminal.appendChild(inputLine);

                // Handle clear command
                if (code.trim() === 'clear') {
                    terminal.innerHTML = '';
                    addWelcomeMessage();
                    input.value = '';
                    return;
                }

                // Execute and display result
                try {
                    const result = evalJS(code);
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'mb-4 ml-4';
                    
                    if (result.error) {
                        resultDiv.innerHTML = `<span class="text-red-400">${escapeHtml(result.error)}</span>`;
                    } else {
                        resultDiv.innerHTML = `<span class="text-blue-300">${escapeHtml(result.result)}</span>`;
                    }
                    terminal.appendChild(resultDiv);
                } catch (e) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'mb-4 ml-4 text-red-400';
                    errorDiv.textContent = e.toString();
                    terminal.appendChild(errorDiv);
                }

                // Clear input and scroll to bottom
                input.value = '';
                adjustTextareaHeight();
                terminal.scrollTop = terminal.scrollHeight;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function focusInput() {
                document.getElementById('terminal-input').focus();
            }

            function adjustTextareaHeight() {
                const textarea = document.getElementById('terminal-input');
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            }

            function handleKeyPress(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    executeCode();
                }
            }

            // Command history
            let commandHistory = [];
            let historyIndex = -1;

            function handleKeyDown(event) {
                const input = document.getElementById('terminal-input');
                
                if (event.key === 'Tab') {
                    event.preventDefault();
                    const start = input.selectionStart;
                    const end = input.selectionEnd;
                    input.value = input.value.substring(0, start) + '\t' + input.value.substring(end);
                    input.selectionStart = input.selectionEnd = start + 1;
                    adjustTextareaHeight();
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    if (historyIndex < commandHistory.length - 1) {
                        historyIndex++;
                        input.value = commandHistory[commandHistory.length - 1 - historyIndex];
                        adjustTextareaHeight();
                    }
                } else if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    if (historyIndex > 0) {
                        historyIndex--;
                        input.value = commandHistory[commandHistory.length - 1 - historyIndex];
                        adjustTextareaHeight();
                    } else if (historyIndex === 0) {
                        historyIndex = -1;
                        input.value = '';
                        adjustTextareaHeight();
                    }
                } else if (event.key === 'Enter' && !event.shiftKey) {
                    if (input.value.trim()) {
                        commandHistory.push(input.value);
                        historyIndex = -1;
                    }
                }
            }

            // Handle viewport resize for mobile keyboards
            function updateViewportHeight() {
                const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
                document.documentElement.style.setProperty('--viewport-height', `${vh}px`);
                
                // Scroll to top when keyboard opens on iOS
                window.scrollTo(0, 0);
            }

            window.addEventListener('load', updateViewportHeight);
            window.addEventListener('resize', updateViewportHeight);
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', updateViewportHeight);
                window.visualViewport.addEventListener('scroll', () => {
                    window.scrollTo(0, 0);
                });
            }
        </script>
        <style>
            :root {
                --viewport-height: 100vh;
            }
            html, body {
                height: var(--viewport-height);
                overflow: hidden;
                position: fixed;
                width: 100%;
            }
        </style>
    </head>
    <body class="bg-black p-0 md:p-4 font-mono md:flex md:items-center md:justify-center" onclick="focusInput()">
        <div class="h-full md:h-auto md:max-w-5xl md:w-full">
            <div class="bg-gray-900 md:rounded-lg shadow-2xl overflow-hidden border-0 md:border border-gray-700 h-full md:h-[600px] md:max-h-[80vh] flex flex-col">
                <div class="bg-gray-800 px-4 py-2 flex items-center gap-2 border-b border-gray-700">
                    <div class="flex gap-2">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                    </div>
                    <div class="ml-4 text-gray-400 text-sm">go-js-runtime â€” terminal</div>
                </div>
                
                <div class="p-4 flex-1 flex flex-col overflow-hidden">
                    <div 
                        id="terminal" 
                        class="text-gray-100 text-sm flex-1 overflow-y-auto mb-2">
                    </div>
                    
                    <div class="flex items-start">
                        <span class="text-green-400 mr-2 leading-normal">$</span>
                        <textarea 
                            id="terminal-input" 
                            class="flex-1 bg-transparent text-gray-100 outline-none caret-green-400 resize-none leading-normal overflow-hidden"
                            onkeypress="handleKeyPress(event)"
                            onkeydown="handleKeyDown(event)"
                            oninput="adjustTextareaHeight()"
                            autocomplete="off"
                            autocorrect="off"
                            autocapitalize="off"
                            spellcheck="false"
                            rows="1"
                            autofocus></textarea>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
